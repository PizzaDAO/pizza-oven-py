stages:
  - build
  - deploy
image: docker:19.03.12
services:
  - docker:19.03.12-dind

build-chainlink-rinkby:
  stage: build
  before_script:
    - apk add --update --no-cache py-pip
    - pip install awscli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME
  only:
    refs:
      - tags
    variables: 
      - $CI_COMMIT_TAG =~ /chainlink-rinkby/i
  script:
    - docker build -t chainlink-rinkby /chainlink
    - docker tag chainlink-rinkby $ACCOUNT_ID_NUMBER.dkr.ecr.$AWS_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME:$CI_COMMIT_TAG
    - docker push chainlink-rinkby $ACCOUNT_ID_NUMBER.dkr.ecr.$AWS_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME:$CI_COMMIT_TAG
    
build-chainlink-rinkby:
  stage: build
  before_script:
    - apk add --update --no-cache py-pip
    - pip install awscli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME
  only:
    refs:
      - tags
    variables: 
      - $CI_COMMIT_TAG =~ /chainlink-mainnet/i
  script:
    - docker build -t chainlink-mainnet /chainlink
    - docker tag chainlink-mainnet $ACCOUNT_ID_NUMBER.dkr.ecr.$AWS_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME:$CI_COMMIT_TAG
    - docker push chainlink-mainnet $ACCOUNT_ID_NUMBER.dkr.ecr.$AWS_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME:$CI_COMMIT_TAG

build-oven:
  stage: build
  before_script:
    - apk add --update --no-cache py-pip
    - pip install awscli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME
  only:
    refs:
      - tags
    variables: 
      - $CI_COMMIT_TAG =~ /pizza-oven/i
  script:
    - docker build -t pizza-oven .
    - docker tag pizza-oven $ACCOUNT_ID_NUMBER.dkr.ecr.$AWS_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME:$CI_COMMIT_TAG
    - docker push pizza-oven $ACCOUNT_ID_NUMBER.dkr.ecr.$AWS_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME:$CI_COMMIT_TAG

build-all:
  stage: build
  before_script:
    - apk add --update --no-cache py-pip
    - pip install awscli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME
  only:
    refs:
      - tags
    variables: 
      - $CI_COMMIT_TAG =~ /all/i
  script:
    - docker build -t pizza-oven .
    - docker tag pizza-oven $ACCOUNT_ID_NUMBER.dkr.ecr.$AWS_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME:"$CI_COMMIT_TAG"-pizza-oven
    - docker push pizza-oven $ACCOUNT_ID_NUMBER.dkr.ecr.$AWS_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME:"$CI_COMMIT_TAG"-pizza-oven
    - docker build -t chainlink-rinkby .
    - docker tag chainlink-rinkby $ACCOUNT_ID_NUMBER.dkr.ecr.$AWS_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME:"$CI_COMMIT_TAG"-chainlink-rinkby
    - docker push chainlink-rinkby $ACCOUNT_ID_NUMBER.dkr.ecr.$AWS_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME:"$CI_COMMIT_TAG"-chainlink-rinkby


deploy-all:
  stage: deploy
  image: dtzar/helm-kubectl:3.1.2
  needs: ["build-all"]
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /all/i
  script:
    helm upgrade -i --reuse-values --set pizzaOven.tag="$CI_COMMIT_TAG"-pizza-oven --set chainlink.mainnet.enabled=false --set chainlink.image.rinkbyTag="$CI_COMMIT_TAG"-chainlink-rinkby --set image.repository=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$CLUSTER_NAME-$PROJECT_NAME rarepizzas rarepizza-chart

